{% extends "static_site/base.html" %}

{% block main_content %}

<main id="content" role="main">
  {%  include 'static_site/phase_banner.html' %}
  <div class="breadcrumbs">
    <ol>
      <li><a href="{{ url_for('static_site.index') }}" data-event="breadcrumb-homepage">Ethnicity facts and figures</a></li>
      <li>
        <a href="{{ url_for('static_site.topic', topic=topic) }}" data-event="breadcrumb-{{ topic }}">{{ topic | breadcrumb_friendly }}</a>
      </li>
    </ol>
  </div>

  <div class="grid-row">
    <div class="column-two-thirds">
      <h1 class="heading-large">
        {{ measure_page.title }}
      </h1>
      <div class="metadata">
        <dl>
          {% if measure_page.geographic_coverage %}
          <dt>Location:</dt>
          <dd>
            {{ measure_page.geographic_coverage }}
          </dd>
          {% endif %}
          {% if measure_page.time_covered %}
          <dt>Time period:</dt>
          <dd>
            {{ measure_page.time_covered }}
          </dd>
          {% endif %}
          {% if measure_page.source_text %}
          <dt>Source:</dt>
          <dd>
            <a href="{{ measure_page.source_url }}" data-event="metadata-measure-page-source-url">
              {{ measure_page.source_text }}
            </a>
          </dd>
          {% endif %}
          {% if measure_page.department_source %}
          <dt>Department:</dt>
          <dd>
            {{ measure_page.department_source }}
          </dd>
          {% endif %}
          {% if measure_page.last_update_date %}
          <dt>Last updated:</dt>
          <dd>
            {{ measure_page.last_update_date }}
          </dd>
          {% endif %}
        </dl>
      </div>
    </div>
  </div>

  <div class="grid-row">
    <div class="column-two-thirds">
      <p>
        The main facts and figures show that:
      </p>
      <div class="bullets spaced-out">
        <p>
          {{ measure_page.summary | render_markdown }}
        </p>
      </div>


      {% if measure_page.need_to_know %}
      <details data-event="data-reliability" class="normalize">
        <summary>
          <span class="summary">
            The reliability of the data
          </span>
        </summary>
        <div class="panel panel-border-narrow">
          <p>
            {{ measure_page.need_to_know | render_markdown  }}
          </p>
        </div>
      </details>
      {% endif %}

      {% if measure_page.measure_summary %}
      <details data-event="data-measured" class="normalize">
        <summary>
          <span class="summary">
            What the data measures
          </span>
        </summary>
        <div class="panel panel-border-narrow">
          <p>
            {{ measure_page.measure_summary | render_markdown  }}
          </p>
        </div>
      </details>
      {% endif %}

      {% if measure_page.ethnicity_definition_summary %}
      <details data-event="categories-chosen" class="normalize">
        <summary>
          <span class="summary">
            Why the categories of ethnicities used in this data were chosen
          </span>
        </summary>
        <div class="panel panel-border-narrow">
          <p>
            {{ measure_page.ethnicity_definition_summary | render_markdown  }}
          </p>
          <p><a href="{{ url_for('static_site.ethnic_groups_and_data_collected') }}{% if static_mode %}.html{%  endif %}">Ethnic groups and how data on ethnicity is collected</a></p>
        </div>
      </details>
      {% endif %}
    </div>
  </div>

  <div class="grid-row">
    {% if measure_page.dimensions %}
    {% for dimension in dimensions  %}
    <div class="column-two-thirds">

      <h2 class="heading-medium">{{ dimension.title }}</h2>

      <div class="metadata">
        <dl>
          {% if dimension.location %}
          <dt>Location:</dt>
          <dd>
            {{ dimension.location }}
          </dd>
          {% endif %}
          {% if dimension.time_period %}
          <dt>Time period:</dt>
          <dd>
            {{ dimension.time_period }}
          </dd>
          {% endif %}
          {% if dimension.source %}
          <dt>Source:</dt>
          <dd>
            {{ dimension.source | render_markdown  }}
          </dd>
          {% endif %}
        </dl>
      </div>
    </div>

    <div class="column-full" style="{% if not dimension.table and not dimension.chart %}display: none;{% endif %}">
      <div class="rd_chart" id="chart_{{ dimension.guid }}"></div>
      {% if dimension.table %}
      <details data-event="view-table" class="normalize" {{ '' if dimension.chart else 'open' }}>
        <summary>
          <span class="summary">View the numbers in a table</span>
        </summary>
        <div class="panel panel-border-narrow">
          {{ dimension.header }}
          {% if dimension.table.header %}
            <h3 class="heading-small">{{ dimension.table.header }}</h3>
          {% endif %}
          {% if dimension.table.subtitle %}
            <p class="subtitle">{{ dimension.table.subtitle }}</p>
          {% endif %}
          <table columns='{{ dimension.table.columns|length if dimension.table.type == "grouped" }}' class="table{{ ' cropped' if dimension.table.data|length > 10 }}{{ ' grouped' if dimension.table.type == 'grouped' }}{{ ' extra-wide' if dimension.table.group_columns|length > 5 }}">
            <thead>
              {% if dimension.table.type == "grouped" %}
              {% set total_cells = (dimension.table.columns|length * (dimension.table.group_columns|length - 1  )) + 1 %}
              <tr>
                {% for group_column in dimension.table.group_columns %}
                {% if group_column %}
                <td style="width:{{ (100 / total_cells) * dimension.table.columns|length }}%" colspan="{{ dimension.table.columns|length }}" class="{{ '' if loop.last else 'line' }}">
                {% else %}
                <td style="width:{{ (100 / total_cells) * 1 }}%">
                {% endif %}
                {{ group_column|safe }}</td>
                {% endfor %}
              </tr>
              {% endif %}
              <tr>
                <td style="width:{{ 100 / loop.length }}%"><button>{{ dimension.table.category }}</button></td>
                {% if dimension.table.type == "grouped" %}
                {% for group_column in dimension.table.group_columns %}
                {% if loop.index0 != 0 %}
                {% for column in dimension.table.columns %}
                  <td style="width:{{ 100 / loop.length }}%"><button>{{ column }}</button></td>
                {% endfor %}
                {% endif %}
                {% endfor %}
                {% else %}
                {% for text in dimension.table.columns %}
                <td style="width:{{ 100 / loop.length }}%">
                  <button>
                    {{ text|safe }}
                  </button>
                </td>
                {% endfor %}

                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for data in dimension.table.data %}
              <tr>
                {% for text in data['values'] %}
                  {% if loop.first %}
                  <th style="width:{{ 100 /(loop.length + 1) }}%">
                    <b>{{ data.category }}</b>
                  </th>
                  <td style="width:{{ 100 /(loop.length + 1) }}%">
                    {{ text }}
                  </td>
                  {% else %}
                  <td style="width:{{ 100 /(loop.length + 1) }}%">
                    {{ text }}
                  </td>
                  {% endif %}
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% if dimension.table.footer %}
            <p class="table-footer">{{ dimension.table.footer }}</p>
          {% endif %}
        </div>
      </details>
      {% endif %}
    </div>
    <div class="column-two-thirds">
      <h3 class="heading-small">Summary</h3>
      <p>
        {{ dimension.summary | render_markdown }}
      </p>
    </div>
    <div class="column-one-third" style="{% if not dimension.table and not dimension.chart %}display: none;{% endif %}">
      <h3 class="heading-small">Download data</h3>
      <ul class="no-bullets font-size-small">
        <li>
          <a href="##" data-event="measure-download-graph-image" class="download-png" id="download-{{ dimension.guid }}">
            Image of graphs (PNG)
          </a>
        </li>
        <li>
            {%  if static_mode %}
                <a href="downloads/{{ dimension.static_file_name }}" download="{{ dimension.static_file_name }}">Source data (CSV)</a>
            {%  else %}
                <a href="{{ url_for('static_site.dimension_file_download',
                               topic='topic_%s' % topic,
                               subtopic='subtopic_%s' % subtopic,
                               measure=measure_page.guid,
                               dimension=dimension.guid) }}" data-event="measure-download-csv"> Source data (CSV)
                </a>
            {% endif %}
        </li>
        <li>
          <a href="##" data-event="measure-download-odf">
            Source data – Open document format (ODF)
          </a>
        </li>
        <li>
          <a href="##" data-event="measure-download-xls">
            Source data – Microsoft Excel (XLS)
          </a>
        </li>
      </ul>
    </div>
    {% endfor %}
    {% endif %}
  </div>

  <div class="grid-row">
    <div class="accordions-container container">
      <div class="accordion">
        <div class="column-two-thirds">

          <div data-event="methodology" class="accordion__header">
            <h2>
              <button>
                Methodology and data type
              </button>
            </h2>
            <span class="plus-minus-icon"></span>
          </div>

          <div class="accordion__body" style="display: none;">

            {% if measure_page.data_source_purpose %}
            <h3 class="heading-small">
              Purpose Of Data Source
            </h3>
            <p>
              {{ measure_page.data_source_purpose | render_markdown }}
            </p>
            {% endif %}

            {% if measure_page.methodology %}
            <h3 class="heading-small">
              Methodology
            </h3>
            <p>
              {{ measure_page.methodology | render_markdown  }}
            </p>
            {% endif %}

            {% if measure_page.data_type %}
            <h3 class="heading-small">
              Data type
            </h3>
            <p>
              {{ measure_page.data_type }}
            </p>
            {% endif %}

            {% if measure_page.type_of_statistic %}
            <h3 class="heading-small">
              Type of statistic
            </h3>
            <p>
              {{ measure_page.type_of_statistic }}
            </p>
            {% endif %}

            {% if measure_page.suppression_rules %}
            <h3 class="heading-small">
              Suppression rules
            </h3>
            <p>
              {{ measure_page.suppression_rules | render_markdown }}
            </p>
            {% endif %}

            {% if measure_page.disclosure_control %}
            <h3 class="heading-small">
              Disclosure control
            </h3>
            <p>
              {{ measure_page.disclosure_control | render_markdown  }}
            </p>
            {% endif %}

            {% if measure_page.estimation %}
            <h3 class="heading-small">
              Estimation
            </h3>
            <p>
              {{ measure_page.estimation  | render_markdown  }}
            </p>
            {% endif %}

            {% if measure_page.quality_assurance %}
            <h3 class="heading-small">
              Quality assurance
            </h3>
            <p>
              {{ measure_page.quality_assurance  | render_markdown }}
            </p>
            {% endif %}

            {% if measure_page.further_technical_information %}
            <h3 class="heading-small">
              Further technical information
            </h3>
            <p>
              {{ measure_page.further_technical_information  | render_markdown }}
            </p>
            {% endif %}

          </div>

        </div>
      </div>

      <div class="accordion">
        <div class="column-two-thirds">

          <div data-event="publishing-details" class="accordion__header">
            <h2>
              <button>
                Publishing details
              </button>
            </h2>
            <span class="plus-minus-icon"></span>
          </div>

          <div class="accordion__body" style="display: none;">
            <dl>
              {% if measure_page.source_text %}
              <dt class="meta-heading">Source:</dt>
              <dd>
                <p>
                  <a href="{{ measure_page.source_url }}" data-event="accordion-measure-source-url">
                    {{ measure_page.source_text }}
                  </a>
                </p>
              </dd>
              {% endif %}
              {% if measure_page.department_source %}
              <dt class="meta-heading">Department:</dt>
              <dd>
                {{ measure_page.department_source | render_markdown }}
              </dd>
              {% endif %}
              {% if measure_page.published_date %}
              <dt class="meta-heading">First published:</dt>
              <dd>
                <p>
                  {{ measure_page.published_date }}
                </p>
              </dd>
              {% endif %}
              {% if measure_page.last_update_date %}
              <dt class="meta-heading">Last updated:</dt>
              <dd>
                <p>
                  {{ measure_page.last_update_date }}
                </p>
              </dd>
              {% endif %}
              {% if measure_page.next_update_date %}
              <dt class="meta-heading">Next update:</dt>
              <dd>
                <p>
                  {{ measure_page.next_update_date }}
                </p>
              </dd>
              {% endif %}
              {% if measure_page.frequency %}
              <dt class="meta-heading">Frequency:</dt>
              <dd>
                <p>
                  {{ measure_page.frequency }}
                </p>
              </dd>
              {% endif %}
              {% if measure_page.related_publications %}
              <dt class="meta-heading">Related publications:</dt>
              <dd>
                <p>
                  {{ measure_page.related_publications | render_markdown }}
                </p>
              </dd>
              {% endif %}
              {% if measure_page.revisions %}
              <dt class="meta-heading">Revisions:</dt>
              <dd>
                <p>
                  {{ measure_page.revisions }}
                </p>
              </dd>
              {% endif %}
            </dl>

          </div>

        </div>
      </div>

      <div class="accordion">
        <div class="column-two-thirds">

          <div data-event="download-data" class="accordion__header">
            <h2>
              <button>
                Download the data
              </button>
            </h2>
            <span class="plus-minus-icon"></span>
          </div>

          <div class="accordion__body downloads" style="display: none;">
            {% for file in measure_page.uploads  %}
              {% if file.file_name %}
                  {%  if static_mode %}
                    <a href="downloads/{{ file.file_name }}" download="{{ file.file_name }}">{{ file.file_name }}</a>
                  {%  else %}
                      <a href="{{ url_for('static_site.measure_page_file_download',
                    topic='topic_%s' % topic,
                    subtopic='subtopic_%s' % subtopic,
                    measure=measure_page.guid,
                    filename=file.file_name) }}" data-event="accordion-download-page">
                      {{ file.title }}
                      {{ " - Spreadsheet " if file.extension() == "csv" }}
                      {{ " - Microsoft Excel " if file.extension() == "xls" or file.extension() == "xlsx" }}
                      {{ " - Open Document Format " if file.extension() == "odf" }}
                      ({{ file.extension() }})
                      {{ file.size|filesize }}
                    </a>
                      {% endif %}
                {% if file.description %}
                  <p>{{ file.description }}</p>
                {% endif %}
              {% endif %}
            {% endfor %}
            <button class="js--print print-btn">Print this page</button>
          </div>

        </div>
      </div>
    </div>
  </div>
</main>

{% endblock %}

{% block body_end_more %}
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/5.0.11/highcharts.js"></script>
<script type="text/javascript" src="{{ asset_path }}vendor/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="{{ asset_path }}vendor/underscore-min.js"></script>
<script src="{{ url_for('static', filename='javascripts/rd-data-tools.js') }}"></script>
<script src="{{ url_for('static', filename='javascripts/rd-graph.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/5.0.11/modules/exporting.js"></script>
<script type="text/javascript">

  var dimensions = {{ dimensions|tojson }};

  $(document).ready(function () {
    for (d in dimensions) {
      var chartObject = dimensions[d].chart;
      drawChart('chart_' + dimensions[d].guid, chartObject);
    };

    {% if static_mode %}

        var sendToAnalytics = function (event) {
            var eventLabel = $(event.currentTarget).data('event');

            if (!eventLabel && $(event.currentTarget).attr('href')){
                eventLabel = $(event.currentTarget).attr('href');
            }

            ga('send', {
              hitType: 'event',
              eventCategory: 'Action',
              eventAction: 'click',
              eventLabel: eventLabel
            });
        };

        $('details.normalize').click(function(event) {
            sendToAnalytics(event);
        });

        $('.accordion__header').click(function(event) {
             sendToAnalytics(event);
        });

        $('a').click(function(event){
            sendToAnalytics(event);
        });

    {%  endif %}
  
    $('.download-png').click(function(evt){
        var dimensionGuid = $(evt.currentTarget).attr('id').replace('download-', ''),
            chartId = '#chart_' + dimensionGuid,
            chart = $(chartId),
            dimension = dimensions.find(function(d){return d.guid == dimensionGuid});

        var subtitle = 'Location: ' + dimension.location
                                    + '. Time period: '
                                    + dimension.time_period
                                    + '. Source: ' + getSourceText(dimension.source)
                                    + '|Ethnicity Facts and Figures GOV.UK';

        chart.highcharts().options.subtitle.text = subtitle;
        chart.highcharts().exportChart();
    });


    function getSourceText(source){
        var regex = /\[(.*?)\]\(.*?\)/;
        if(regex.test(source)){
            var match = regex.exec(source);
            if(match.length == 2) {
               return match[1];
            }
            else {
                return source;
            }
        } else {
            return source;
        }
    };

  });
</script>
{% endblock %}

