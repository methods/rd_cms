{% extends "base.html" %}

{% set breadcrumbs =
  [
    {"url": url_for("static_site.index"), "text": "Ethnicity facts and figures"},
  ]
%}

{% block pageTitle %}{{ topic.title }} - GOV.UK Ethnicity facts and figures{% endblock %}
{% block socialTitle %}{{ topic.title }}{% endblock %}
{% block googleAnalytics %}ga('set','contentGroup1','Topic');{% endblock %}

{% block content %}
        <div class="grid-row">
            <div class="column-two-thirds">
                <h1 class="heading-xlarge">
                    {{ topic.title }}
                </h1>
                {% if topic.additional_description  %}
                    <p>
                        {{ topic.additional_description | render_markdown  }}
                    </p>
                {% endif %}
            </div>
        </div>

        <div class="grid-row">

            <div class="column-two-thirds">

                <div class="accordion">
                    <div class="container">
                        {% for subtopic in (subtopics|selectattr('has_published_measures') if static_mode else subtopics) %}
                            {% if measures_by_subtopic[subtopic.id]|length > 0 or (current_user.is_authenticated and current_user.can(CREATE_MEASURE)) %}
                                <div class="accordion-section">
                                    <div class="accordion-section-header" data-on="click" data-event-category="Accordion" data-event-action="Section opened" data-event-label="{{ subtopic.title }}" >
                                        <h2 class="heading-medium">
                                            {{- subtopic.title -}}{% if subtopic.has_published_measures == false %} (not published){% endif %}
                                        </h2>
                                    </div>
                                    <div class="accordion-section-body {% if not static_mode %}eff-!-padding-bottom-40{% endif %}">
                                        {% if not static_mode %}
                                            {% if current_user.is_authenticated and current_user.can(CREATE_MEASURE) %}
                                                <p class="button-container"><a href="{{ url_for('cms.create_measure', topic_slug=topic.slug, subtopic_slug=subtopic.slug) }}" class="button">Create a new page</a></p>
                                            {% endif %}
                                        {% endif %}
                                        {% if measures_by_subtopic[subtopic.id] %}
                                                <ul class="links js-reorderable">
                                                    {% for measure in measures_by_subtopic[subtopic.id] %}
                                                        {% with measure_version = measure.latest_version %}
                                                            <li data-measure-id="{{ measure.id }}" data-subtopic-id="{{ subtopic.id }}">
                                                                <a href="{{ url_for('static_site.measure_version',
                                                                                    topic_slug=topic.slug,
                                                                                    subtopic_slug=subtopic.slug,
                                                                                    measure_slug=measure.slug,
                                                                                    version='latest') }}">{{ measure_version.title }}
                                                                </a>

                                                                {% if not static_mode and not measure_version.status == "APPROVED" %}
                                                                    &nbsp;({{ measure_version.status | format_status | safe }}&nbsp;{{ measure_version.version }})

                                                                {% endif %}
                                                            </li>
                                                        {% endwith %}
                                                    {% endfor %}
                                                </ul>
                                        {% endif %}

                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
{% endblock %}


    {% block bodyEnd %}
        {{ super( )}}

        {% if not static_mode and current_user.is_authenticated and current_user.can(ORDER_MEASURES) %}

        <script type="text/javascript">

            var setupReorderableTables = function() {
                var reOrderableLists = document.querySelectorAll('.js-reorderable');
                reOrderableLists.forEach(function (list) {
                    if (list.children.length > 1) {
                        var r = new ReorderableListItems(list);
                        r.onDrop = orderMeasures;
                    }
                });
            };

            var orderMeasures = function(list) {

                var status = list.parentElement.previousElementSibling;
                var savingIntervalId;

                var stillSaving = function () {
                    switch (status.textContent) {
                        case 'Saving new order':
                            status.textContent = 'Saving new order.';
                            break;
                        case 'Saving new order.':
                            status.textContent = 'Saving new order..';
                            break;
                        case 'Saving new order..':
                            status.textContent = 'Saving new order...';
                            break;
                        case 'Saving new order...':
                            status.textContent = 'Saving new order';
                            break;
                    }
                };

                var saved = function (savingIntervalId) {
                    clearInterval(savingIntervalId);
                    status.textContent = 'Saved';
                    status.classList.add('status-invisible');
                };

                var positions = [];
                for(var i = 0; i < list.children.length; i++) {
                     positions.push({"position": i,
                                     "measure_id": list.children[i].dataset.measureId,
                                     "subtopic_id": list.children[i].dataset.subtopicId})
                }

                status.classList.remove('status-invisible');
                status.textContent = 'Saving new order';
                savingIntervalId = setInterval(stillSaving, 300);
                list.classList.toggle('reorderable');

                $.ajax({
                    type: 'POST',
                    url: "{{ url_for('cms.set_measure_order') }}",
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({"positions": positions}),
                    success: function (data) {
                        console.log('Set order for measures:', positions);
                        saved(savingIntervalId);
                        list.classList.toggle('reorderable');
                    },
                    error: function (data) {
                        console.log('Error setting order for measures:', positions);
                    }
                });
            };

            setupReorderableTables();

        </script>

        {% endif %}

    {% endblock %}
