{% extends "cms/base_measure_page.html" %}
{% block page_title %}
    <h2 class="heading-large">
        Edit measure
    </h2>
{% endblock %}
{% block main_content %}

    {% block measure_form %}
        <div class="edit-form">
        <form method="POST"
              action="{{ url_for('cms.edit_measure_page', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid) }}">
            {{ form.csrf_token }}
            {% block fields %}
                {{ super() }}
            {% endblock fields %}
            <button type="submit" id="submit-form" class="hidden"/>
            Submit</button>
        </form>
        <h3 class="heading-medium">Downloads</h3>
        {% if measure.uploads %}
            <table>
                {% for upload in measure.uploads %}
                    <tr>
                        <td><a href="{{ url_for('static_site.measure_page_file_download', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid, filename=upload.file_name) }}">{{ upload.file_name }}</a></td>
                        <td>{{ upload.title }}</td>
                        <td>
                            <a href="{{ url_for('cms.edit_upload', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid, upload=upload.guid ) }}">{% if 'UPDATE' in available_actions %}edit{% else %}view{% endif %}</a>
                        </td>
                        <td>
                            {% if 'UPDATE' in available_actions %}
                            <a href="{{ url_for('cms.delete_upload', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid, upload=upload.guid ) }}">delete</a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </table>
        {% endif %}
        {% if 'UPDATE' in available_actions %}
        <a href="{{ url_for('cms.create_upload', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid) }}">Add upload</a><br/>
        {% endif %}
    {% endblock %}
</div>
{% endblock %}


{% block left_content %}
    <div class="status">
        <h2>Status:</h2>
        <p>{{ status | format_as_title }}</p>
    </div>
    <div class='preview sticky-js'>
        <ul class="button-group" data-topbar data-options="sticky_on: large">
            {% if "UPDATE" in available_actions %}
                <li>
                    {% if status == 'REJECTED' or status == 'UNPUBLISHED' %}
                         <a class="button-secondary"
                            href="{{ url_for('cms.send_page_to_draft', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid) }}">
                            Send back to draft
                        </a>

                      {% else %}
                            <label for="submit-form" type="submit" class="button" name="save">
                                Save
                            </label>
                      {%  endif %}
                </li>
            {% endif %}

            {% if  "APPROVE" in available_actions %}
                <li>
                    <a class="button-secondary"
                       href="{{ url_for('cms.publish_page', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid) }}">
                        {{ next_approval_state | format_approve_button }}
                    </a>
                </li>
            {% endif %}
            {% if "REJECT" in available_actions %}
                <li>
                    <a class="button-secondary reject"
                       href="{{ url_for('cms.reject_page', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid) }}">
                        Reject
                    </a>
                </li>
            {% endif %}

            {% if "UNPUBLISH" in available_actions %}
                <li>
                    <a class="button-secondary unpublish"
                       href="{{ url_for('cms.unpublish_page', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid) }}">
                        Unpublish
                    </a>
                </li>
            {% endif %}

            <li class='preview-link'>
                <a href="{{ url_for('static_site.measure_page', topic=topic.uri, subtopic=subtopic.uri, measure=measure.uri) }}" name="preview">
                    View preview
                </a>
            </li>
        </ul>
    </div>
{% endblock %}

{% block scripts %}
    <script>

        function refreshFileList() {
            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: "{{ url_for('cms.get_measure_page_uploads', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid)}}",
                success: function (page) {
                    var fileListHtml = '';
                    for (i in page.uploads) {
                        fileListHtml = fileListHtml + '<tr>' +
                            '<td>' + page.uploads[i] + '</td>' +
                            '<td><a href="/cms/{{ topic.guid }}/{{ subtopic.guid }}/{{ measure.guid }}/uploads/' + page.uploads[i] + '/delete">Delete</a></td>' +
                            '</tr>';
                    }
                    $('#fileList').html(fileListHtml);
                }
            })
        }

        function kickOffBuild(){
            $.ajax({
                    type: 'GET',
                    url: "{{ url_for('cms.build_static_site') }}",
                    success: function (data) {
                        console.log('Build static site', data);
                    },
                    error: function (data) {
                        console.log('Failed to build static build', data);
                    }
                });
        }

        function moveDimensionUp(event){
            event.preventDefault();
            var row = $(event.currentTarget).parents('tr:first');
            if(row.prev().length > 0){
                row.insertBefore(row.prev());
                syncDimensionOrder();
            }
        }

        function moveDimensionDown(event){
            event.preventDefault();
            var row = $(event.currentTarget).parents('tr:last');
            if(row.next().length > 0) {
                row.insertAfter(row.next());
                syncDimensionOrder();
            }
        }

        function syncDimensionOrder(){
            var rows = $('tr.movable'),
                dimensions = [],
                guid;

            $(rows).each(function(index, row){
                guid = $(row).data('dimension-guid');
                dimensions.push({"index": index, "guid": guid});
            });
            $.ajax({
                    type: 'POST',
                    url: "{{ url_for('cms.set_dimension_order', topic=topic.guid,
                                                                subtopic=subtopic.guid,
                                                                measure=measure.guid) }}",
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({"dimensions": dimensions}),
                    success: function (data) {
                        console.log('Set order for dimensions:', dimensions);
                    },
                    error: function (data) {
                        console.log('Error setting order for dimensions:', dimensions);
                    }
                });
        }

        $(document).ready(function () {

            refreshFileList();

            {% if build %}
                kickOffBuild();
            {% endif %}

            $('.move-up').click(moveDimensionUp);
            $('.move-down').click(moveDimensionDown);

        });
    </script>

{% endblock %}