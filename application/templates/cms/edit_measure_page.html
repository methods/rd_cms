{% extends "cms/base_measure_page.html" %}
{% block page_title %}
  <h2 class="heading-large">
    Edit measure
  </h2>
{% endblock %}
{% block main_content %}

{% block measure_form %}
<div class="edit-form">
  <form method="POST"
  action="{{ url_for('cms.edit_measure_page', topic=topic.meta.guid, subtopic=subtopic.meta.guid, measure=measure.meta.guid) }}">
  {{ form.csrf_token }}
      {% block fields %}
  {{ super() }}
  {% endblock fields %}
  <button type="submit" id="submit-form" class="hidden" />Submit</button>
</form>
<h3>Downloads</h3>
<div>
<table id="fileList">
{% for upload in measure.uploads %}
  <tr>
      <td>{{ upload }}</td>
      <td><a href="{{ url_for('cms.delete_upload', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid, upload=upload) }}">delete</a></td>
  </tr>
{% endfor %}
</table>
<label for="fileUpload" class="button">Upload a data file</label>
<div><input class="show-for-sr" type="file" id="fileUpload" value="Input"></div>
</div>
{% endblock %}
</div>
{% endblock %}


{% block left_content %}
<div class="status {{ status }}">
  <h2>Status:</h2>
  <p>{{ status | format_as_title }}</p>
</div>
<div class='preview sticky-js'>
  <ul class="button-group" data-topbar data-options="sticky_on: large">
    {% if "UPDATE" in available_actions %}
    <li>
      <label for="submit-form" type="submit" class="button">
        {% if status == 'rejected' %}
        Send back to review
        {% else %}
        Save
        {% endif %}
      </label>
    </li>
    {% endif %}

    {% if  "APPROVE" in available_actions %}
    <li>
      <a class="button-secondary"
      href="{{ url_for('cms.publish_page', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid) }}">
      {{ next_approval_state | format_approve_button }}
    </a>
  </li>
  {% endif %}
  {% if "REJECT" in available_actions %}
          <li>
      <a class="button-secondary reject"
      href="{{ url_for('cms.reject_page', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid) }}">
          Reject
    </a>
  </li>
  {% endif %}

      <li class='preview-link'>
      <a href="{{ url_for('static_site.measure_page', topic=topic.meta.uri, subtopic=subtopic.meta.uri, measure=measure.meta.uri) }}">
        View preview
      </a>
    </li>
</ul>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function () {

    $('#fileUpload').on('change', function () {
      var data = new FormData();
      data.append('file', $('#fileUpload').prop('files')[0]);
      $.ajax({
        type: 'POST',
        processData: false, // important
        contentType: false, // important
        data: data,
        url: "{{ url_for('cms.upload_file', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid)}}",
        dataType: 'json',
        success: function (jsonData) {
          $.ajax({
            type: 'GET',
            dataType: 'json',
            url: "{{ url_for('cms.get_measure_page', topic=topic.guid, subtopic=subtopic.guid, measure=measure.guid)}}",
            success: function (page) {
              var fileListHtml = '';
              for (i in page.uploads) {
                fileListHtml = fileListHtml + '<tr>' +
                    '<td>' + page.uploads[i] + '</td>' +
                    '<td><a href="/cms/{{ topic.guid }}/{{ subtopic.guid }}/{{ measure.guid }}/uploads/' +
                    page.uploads[i] +
                    '/delete">Delete</a></td>'+
                    '</tr>';
              }
              $('#fileList').html(fileListHtml);
            }
          });
          console.log("success");
        },
        failure: function (jsonData) {
          console.log("failure");
        }
      })
    });

  {% if build %}
    $.ajax({
        type: 'GET',
        url: "{{ url_for('cms.build_static_site') }}",
        success: function(data){
            console.log('Build static site', data);
        },
        error: function(data){
            console.log('Failed to build static build', data);
        }
    });
  {% endif %}
  });

</script>
{% endblock %}
